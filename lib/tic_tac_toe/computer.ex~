defmodule TicTacToe.Computer do
  use GenServer

  require Misc

  @cursor Misc.get_config(:cursor)
  @prompt "computer move:" <> @cursor
  @max_moves Misc.get_config(:max_board_size) |> Misc.int_pow(2)

  def start_link(game_info), do: GenServer.start_link(__MODULE__, game_info, name: __MODULE__)

  def next_move(board_tup),  do: GenServer.call(__MODULE__, {:next_move, board_tup})

  def state,                 do: GenServer.call(__MODULE__, :state)


  # external api ^

  def init({}, rem_cells}) do

  def init({turn_tup, rem_cells}) do
    {computer_char, player_char, turn_offset} =
      turn_tup
      |> case  do
        {{__MODULE__, {_, comp}}, {_, {_, player}}} -> {comp, player, 0}

        {{_, {_, player}}, {__MODULE__, {_, comp}}} -> {comp, player, 1}
          
      end

    {:ok, {computer_char, player_char, build_fact_sequence(rem_cells - turn_offset)}}
  end

  def handle_call(:state, _from, state), do: {:ok, state, state}

  def handle_call({:next_move, {board, valids, win_state}}, _from, {}), do: {:ok, state, state}

  def next_move() do
    valid_moves
    |> Enum.each(fn(move)->
      
      
    end)

  end

  # helpers v

  defp build_fact_sequence(open_rem_cells) do
    1..up_to
    |> Range.new(board_size * board_size - turn_offset)
    |> Enum.scan(&(&1 * &2))
    |> Enum.reverse
    |> Enum.take_every(2)
    |> Mis.wrap_pre(:ok)
  end

end
